// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model AssessmentCode {
  code              String    @id
  organizationName  String?   @map("organization_name")
  intendedRecipient String?   @map("intended_recipient")
  expiresAt         DateTime? @map("expires_at")
  isUsed            Boolean   @default(false) @map("is_used")
  usageCount        Int       @default(0) @map("usage_count")
  assessmentType    String    @default("full") @map("assessment_type")
  questionList      String?   @map("question_list") // JSON string of question IDs
  createdAt         DateTime  @default(now()) @map("created_at")

  sessions AssessmentSession[]
  responses UserResponse[]
  results  AssessmentResult[]

  @@map("assessment_codes")
}

model User {
  id               String    @id
  name             String
  email            String?
  organization     String?
  organizationSize String?   @map("organization_size")
  industry         String?
  country          String?
  roleTitle        String?   @map("role_title")
  selectedRoleId   String?   @map("selected_role_id")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  sessions AssessmentSession[]
  results  AssessmentResult[]

  @@map("users")
}

model Role {
  id          String  @id
  title       String
  description String?
  dimensions  String? // JSON string of dimension IDs
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("roles")
}

model AssessmentSession {
  id                   String    @id
  userId               String    @map("user_id")
  code                 String
  status               String    @default("in_progress")
  totalQuestions       Int       @default(35) @map("total_questions")
  questionsAnswered    Int       @default(0) @map("questions_answered")
  completionPercentage Int       @default(0) @map("completion_percentage")
  languagePreference   String    @default("en") @map("language_preference")
  sessionStart         DateTime  @default(now()) @map("session_start")
  sessionEnd           DateTime? @map("session_end")

  user      User           @relation(fields: [userId], references: [id])
  codeRef   AssessmentCode @relation(fields: [code], references: [code])
  responses UserResponse[]

  @@map("assessment_sessions")
}

model UserResponse {
  id             String   @id @default(cuid())
  sessionId      String   @map("session_id")
  questionId     String   @map("question_id")
  selectedOption String   @map("selected_option")
  scoreValue     Int      @default(0) @map("score_value")
  assessmentCode String?  @map("assessment_code")
  answeredAt     DateTime @default(now()) @map("answered_at")

  session AssessmentSession @relation(fields: [sessionId], references: [id])
  codeRef AssessmentCode?   @relation(fields: [assessmentCode], references: [code])

  @@unique([sessionId, questionId])
  @@map("user_responses")
}

model AssessmentResult {
  id                     String   @id
  userId                 String   @map("user_id")
  assessmentCode         String   @map("assessment_code")
  overallScore           Float    @map("overall_score")
  overallMaturityLevel   String   @map("overall_maturity_level")
  completionDate         DateTime @default(now()) @map("completion_date")
  totalQuestionsAnswered Int      @map("total_questions_answered")
  resultsData            String?  @map("results_data") // JSON string

  user    User           @relation(fields: [userId], references: [id])
  codeRef AssessmentCode @relation(fields: [assessmentCode], references: [code])

  @@unique([userId, assessmentCode])
  @@map("assessment_results")
}

model AuditLog {
  id        String   @id
  userType  String   @map("user_type")
  userId    String?  @map("user_id")
  action    String
  details   String?
  ipAddress String?  @map("ip_address")
  timestamp DateTime @default(now())

  @@map("audit_logs")
}

model Admin {
  id           String   @id @default(cuid())
  username     String   @unique
  passwordHash String   @map("password_hash")
  email        String?
  role         String   @default("admin")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("admins")
}

model OrganizationRequest {
  id               String   @id @default(cuid())
  type             String   // "dma" (Data Maturity Assessment) or "consultation"
  organizationName String   @map("organization_name")
  organizationSize String?  @map("organization_size")
  contactName      String   @map("contact_name")
  contactEmail     String   @map("contact_email")
  contactPhone     String?  @map("contact_phone")
  jobTitle         String?  @map("job_title")
  industry         String?
  country          String?
  message          String?
  status           String   @default("pending") // pending, contacted, completed, cancelled
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@map("organization_requests")
}

// ============================================
// ASSESSMENT STRUCTURE MODELS
// ============================================

model MaturityLevel {
  id            String   @id @default(cuid())
  levelNumber   Int      @unique @map("level_number") // 1, 2, 3, 4, 5
  name          String   // "Initial", "Developing", "Defined", "Managed", "Optimized"
  nameAr        String?  @map("name_ar")
  description   String?  @db.Text
  descriptionAr String?  @map("description_ar") @db.Text
  minScore      Float    @map("min_score") // e.g., 1.0
  maxScore      Float    @map("max_score") // e.g., 1.99
  color         String?  // Hex color code for UI
  icon          String?  // Emoji or icon identifier (e.g., "ðŸŒ±", "ðŸ“ˆ", "ðŸš€")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  answerOptions AnswerOption[]

  @@map("maturity_levels")
}

model Domain {
  id            String   @id @default(cuid())
  name          String   // English name
  nameAr        String?  @map("name_ar") // Arabic name
  description   String?  @db.Text
  descriptionAr String?  @map("description_ar") @db.Text
  displayOrder  Int      @default(0) @map("display_order")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  subdomains Subdomain[]

  @@map("domains")
}

model Subdomain {
  id            String   @id @default(cuid())
  domainId      String   @map("domain_id")
  name          String   // English name
  nameAr        String?  @map("name_ar") // Arabic name
  description   String?  @db.Text
  descriptionAr String?  @map("description_ar") @db.Text
  displayOrder  Int      @default(0) @map("display_order")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  domain    Domain     @relation(fields: [domainId], references: [id], onDelete: Cascade)
  questions Question[]

  @@map("subdomains")
}

model Question {
  id              String   @id @default(cuid())
  subdomainId     String   @map("subdomain_id")
  code            String?  @unique // e.g., "Q1", "Q2" for reference
  title           String   // Short title
  titleAr         String?  @map("title_ar")
  text            String   @db.Text // Full question text
  textAr          String?  @map("text_ar") @db.Text
  helpText        String?  @map("help_text") @db.Text
  helpTextAr      String?  @map("help_text_ar") @db.Text
  icon            String?  // Emoji or icon identifier
  displayOrder    Int      @default(0) @map("display_order")
  isRequired      Boolean  @default(true) @map("is_required")
  isActive        Boolean  @default(true) @map("is_active")
  assessmentTypes String   @default("full,quick") @map("assessment_types") // Comma-separated: "full", "quick", or "full,quick"
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  subdomain     Subdomain      @relation(fields: [subdomainId], references: [id], onDelete: Cascade)
  answerOptions AnswerOption[]

  @@map("questions")
}

model AnswerOption {
  id              String   @id @default(cuid())
  questionId      String   @map("question_id")
  maturityLevelId String?  @map("maturity_level_id") // Optional for NA/NS options
  text            String   @db.Text // Answer text
  textAr          String?  @map("text_ar") @db.Text
  scoreValue      Int      @map("score_value") // 1-5 for maturity, 0 for NA/NS
  displayOrder    Int      @default(0) @map("display_order")
  isSpecial       Boolean  @default(false) @map("is_special") // True for NA/NS options
  specialType     String?  @map("special_type") // "NA" or "NS"
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  question      Question       @relation(fields: [questionId], references: [id], onDelete: Cascade)
  maturityLevel MaturityLevel? @relation(fields: [maturityLevelId], references: [id])

  @@map("answer_options")
}
